#!/bin/bash
# ==================================================
# ZiVPN UDP Installer (MAIN)
# Location : Subang, Jawa Barat
# CN       : zivpn 
# Binary   : MacroTunnel
# Cleanup  : ENABLED 
# ==================================================

set -e

# --------------------------------------------------
# Fix hostname
# --------------------------------------------------
HOSTNAME=$(hostname)
grep -q "127.0.0.1 $HOSTNAME" /etc/hosts || echo "127.0.0.1 $HOSTNAME" >> /etc/hosts

# --------------------------------------------------
# Update system
# --------------------------------------------------
apt update -y && apt upgrade -y

# --------------------------------------------------
# Dependencies
# --------------------------------------------------
DEPS="ufw jq curl figlet ruby-full iptables-persistent openssl"
for p in $DEPS; do
    dpkg -l | grep -q $p || apt install -y $p
done

command -v lolcat >/dev/null 2>&1 || gem install lolcat

# --------------------------------------------------
# Stop old service
# --------------------------------------------------
systemctl stop zivpn.service >/dev/null 2>&1 || true

# --------------------------------------------------
# Download ZiVPN Binary 
# --------------------------------------------------
wget -q https://raw.githubusercontent.com/Supremo198/daniel/main/udp-zivpn-linux-amd64 \
-O /usr/local/bin/zivpn-bin
chmod +x /usr/local/bin/zivpn-bin

# --------------------------------------------------
# Config
# --------------------------------------------------
mkdir -p /etc/zivpn
wget -q https://raw.githubusercontent.com/Supremo198/daniel/main/config.json \
-O /etc/zivpn/config.json

# --------------------------------------------------
# Certificate (SUBANG - NO DOMAIN)
# --------------------------------------------------
openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \
-subj "/C=ID/ST=Jawa Barat/L=Subang/O=ZiVPN/OU=UDP Server/CN=zivpn" \
-keyout /etc/zivpn/zivpn.key \
-out /etc/zivpn/zivpn.crt

# --------------------------------------------------
# Kernel tuning
# --------------------------------------------------
sysctl -w net.core.rmem_max=16777216 >/dev/null
sysctl -w net.core.wmem_max=16777216 >/dev/null

# --------------------------------------------------
# Systemd service
# --------------------------------------------------
cat > /etc/systemd/system/zivpn.service << EOF
[Unit]
Description=ZiVPN UDP Server
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/zivpn-bin server -c /etc/zivpn/config.json
Restart=always
RestartSec=3
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

# --------------------------------------------------
# Default database
# --------------------------------------------------
echo "[]" > /etc/zivpn/users.db.json
echo "rainbow" > /etc/zivpn/theme.conf

# --------------------------------------------------
# IPTABLES
# --------------------------------------------------
IFACE=$(ip route | awk '/default/ {print $5}')

iptables -t nat -F
iptables -F

iptables -t nat -A PREROUTING -i $IFACE -p udp --dport 6000:19999 -j DNAT --to-destination :5667
iptables -A FORWARD -p udp --dport 5667 -j ACCEPT
iptables -t nat -A POSTROUTING -o $IFACE -j MASQUERADE

netfilter-persistent save >/dev/null

# --------------------------------------------------
# Firewall
# --------------------------------------------------
ufw allow 6000:19999/udp
ufw allow 5667/udp
ufw --force enable

# --------------------------------------------------
# Menu
# --------------------------------------------------
wget -q https://raw.githubusercontent.com/Supremo198/daniel/main/zivpn-menu.sh \
-O /usr/local/bin/zivpn
chmod +x /usr/local/bin/zivpn

# --------------------------------------------------
# AUTO CLEANUP & BACKUP (WAJIB)
# --------------------------------------------------
wget -q https://raw.githubusercontent.com/myridwan/udp-zivpn/ipuk/zivpn-cleanup.sh \
-O /usr/local/bin/zivpn-cleanup.sh
chmod +x /usr/local/bin/zivpn-cleanup.sh

wget -q https://raw.githubusercontent.com/wibuidc/zivpn-udp/main/zivpn-autobackup.sh \
-O /usr/local/bin/zivpn-autobackup.sh
chmod +x /usr/local/bin/zivpn-autobackup.sh

echo "* * * * * root /usr/local/bin/zivpn-cleanup.sh" > /etc/cron.d/zivpn-cleanup

# --------------------------------------------------
# Start service
# --------------------------------------------------
systemctl daemon-reload
systemctl enable zivpn
systemctl restart zivpn

# --------------------------------------------------
# Info
# --------------------------------------------------
IP=$(curl -s ifconfig.me || hostname -I | awk '{print $1}')

clear
figlet "ZIVPN" | lolcat
echo "======================================" | lolcat
echo " ZiVPN UDP - SUBANG JAWA BARAT" | lolcat
echo "======================================" | lolcat
echo " Server IP : $IP"
echo " UDP Port  : 6000-19999"
echo " Panel     : zivpn"
echo ""
echo " INSTALL SELESAI âœ”"
