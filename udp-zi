#!/bin/bash
# ==================================================
# ZiVPN UDP Installer (XRAY SAFE)
# Author    : MacroTunnel (Revised)
# Location  : Subang, Jawa Barat
# Mode      : SAFE FOR XRAY
# ==================================================

set -e

### -------------------------------
### BASIC FIX
### -------------------------------
HOSTNAME=$(hostname)
grep -q "127.0.0.1 $HOSTNAME" /etc/hosts || echo "127.0.0.1 $HOSTNAME" >> /etc/hosts

### -------------------------------
### UPDATE SYSTEM
### -------------------------------
apt update -y && apt upgrade -y

### -------------------------------
### DEPENDENCIES
### -------------------------------
DEPS="ufw jq curl figlet ruby-full iptables-persistent openssl at"
for p in $DEPS; do
    dpkg -l | grep -q $p || apt install -y $p
done

command -v lolcat >/dev/null 2>&1 || gem install lolcat

### -------------------------------
### STOP OLD ZIVPN ONLY
### -------------------------------
systemctl stop zivpn.service >/dev/null 2>&1 || true

### -------------------------------
### DOWNLOAD ZIVPN BINARY
### -------------------------------
wget -q https://raw.githubusercontent.com/Supremo198/daniel/main/udp-zivpn-linux-amd64 \
-O /usr/local/bin/zivpn-bin
chmod +x /usr/local/bin/zivpn-bin

### -------------------------------
### ZIVPN CONFIG
### -------------------------------
mkdir -p /etc/zivpn /etc/zivpn/ipziv
wget -q https://raw.githubusercontent.com/Supremo198/daniel/main/config.json \
-O /etc/zivpn/config.json

### -------------------------------
### CERTIFICATE (LOCAL / NO DOMAIN)
### -------------------------------
openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
-subj "/C=ID/ST=JawaBarat/L=Subang/O=ZiVPN/CN=zivpn" \
-keyout /etc/zivpn/zivpn.key \
-out /etc/zivpn/zivpn.crt

### -------------------------------
### KERNEL TUNING
### -------------------------------
sysctl -w net.core.rmem_max=16777216 >/dev/null
sysctl -w net.core.wmem_max=16777216 >/dev/null

### -------------------------------
### SYSTEMD SERVICE
### -------------------------------
cat > /etc/systemd/system/zivpn.service <<EOF
[Unit]
Description=ZiVPN UDP Server
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/zivpn-bin server -c /etc/zivpn/config.json
Restart=always
RestartSec=3
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF

### -------------------------------
### DEFAULT DATABASE
### -------------------------------
[ ! -f /etc/zivpn/users.db.json ] && echo "[]" > /etc/zivpn/users.db.json
echo "rainbow" > /etc/zivpn/theme.conf

### -------------------------------
### IPTABLES 
### -------------------------------
IFACE=$(ip route | awk '/default/ {print $5}')

iptables -t nat -C PREROUTING -p udp --dport 6000:6500 -j DNAT --to :5667 2>/dev/null || \
iptables -t nat -A PREROUTING -p udp --dport 6000:6500 -j DNAT --to :5667

iptables -C FORWARD -p udp --dport 5667 -j ACCEPT 2>/dev/null || \
iptables -A FORWARD -p udp --dport 5667 -j ACCEPT

iptables -t nat -C POSTROUTING -o $IFACE -j MASQUERADE 2>/dev/null || \
iptables -t nat -A POSTROUTING -o $IFACE -j MASQUERADE

iptables-save > /etc/iptables/rules.v4

### -------------------------------
### FIREWALL 
### -------------------------------
ufw allow 6000:6500/udp
ufw allow 5667/udp

ufw allow 443/tcp
ufw allow 80/tcp
ufw allow 8443/tcp

ufw --force enable

### -------------------------------
### MENU
### -------------------------------

wget -q https://zvx.my.id/sanz/zi -O /usr/local/bin/zivpn
chmod +x /usr/local/bin/zivpn


### -------------------------------
### AUTO CLEANUP (SAFE)
### -------------------------------
wget -q https://raw.githubusercontent.com/Supremo198/daniel/main/zivpn-cleanup.sh \
-O /usr/local/bin/zivpn-cleanup.sh
chmod +x /usr/local/bin/zivpn-cleanup.sh

echo "*/5 * * * * root /usr/local/bin/zivpn-cleanup.sh" > /etc/cron.d/zivpn-cleanup

### -------------------------------
### START SERVICE
### -------------------------------
systemctl daemon-reexec
systemctl daemon-reload
systemctl enable zivpn
systemctl restart zivpn

### -------------------------------
### INFO
### -------------------------------
IP=$(curl -s ifconfig.me || hostname -I | awk '{print $1}')

clear
figlet "ZIVPN" | lolcat
echo "==================================" | lolcat
echo " ZiVPN UDP - XRAY SAFE MODE" | lolcat
echo "==================================" | lolcat
echo " Server IP : $IP"
echo " UDP Port  : 6000-6500"
echo ""
echo " INSTALL SELESAI âœ”"
